ARG API_COMMONS_VERSION
ARG DOCKER_NAMESPACE
ARG DOCKER_API_COMMONS_REPOSITORY=geek-regime-api-commons

FROM $DOCKER_NAMESPACE/$DOCKER_API_COMMONS_REPOSITORY:$API_COMMONS_VERSION AS api-commons

FROM maven:3.8.5-openjdk-17-slim

ARG REPOSITORY
ARG API_COMMONS_VERSION
ARG API_COMMONS_ARTIFACT_ID=api-commons
ARG API_COMMONS_FROM=/$API_COMMONS_ARTIFACT_ID/target/$API_COMMONS_ARTIFACT_ID-$API_COMMONS_VERSION.jar
ARG API_COMMONS_TO=/root/.m2/repository/com/github/alexeysol/geekregime/$API_COMMONS_ARTIFACT_ID/$API_COMMONS_VERSION

RUN mkdir -p $API_COMMONS_TO
COPY --from=api-commons $API_COMMONS_FROM $API_COMMONS_TO

WORKDIR /app

COPY ./$REPOSITORY/pom.xml ./pom.xml
RUN mvn dependency:go-offline -B
COPY ./$REPOSITORY/src/main ./src/main
RUN mvn package -D maven.test.skip
